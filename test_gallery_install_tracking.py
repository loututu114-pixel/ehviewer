#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
æµ‹è¯•æ¼«ç”»ä¹¦æ™ºèƒ½å®‰è£…ç»Ÿè®¡æœºåˆ¶
éªŒè¯ç”¨æˆ·é¦–æ¬¡æ‰“å¼€æ¼«ç”»ä¹¦æ—¶è§¦å‘çš„å®‰è£…ç»Ÿè®¡
"""

import json
import requests
from datetime import datetime

API_BASE_URL = "https://qudao.eh-viewer.com/api"

def create_gallery_install_data(channel_code="3001", device_id=None):
    """åˆ›å»ºæ¼«ç”»ä¹¦æ™ºèƒ½å®‰è£…ç»Ÿè®¡æµ‹è¯•æ•°æ®"""
    iso_time = datetime.now().strftime('%Y-%m-%dT%H:%M:%S.%f')[:-3] + 'Z'
    
    data = {
        "channelCode": channel_code,
        "softwareId": 1,
        "installTime": iso_time,
        "deviceInfo": {
            "os": "Android 13",
            "model": "Test Device",
            "manufacturer": "Test",
            "brand": "Test", 
            "sdk": 33
        },
        "realInstall": True,  # æ ‡è®°ä¸ºçœŸå®å®‰è£…
        "triggerContext": "gallery_first_open"  # æ ‡è®°è§¦å‘ä¸Šä¸‹æ–‡
    }
    
    if device_id:
        data["deviceId"] = device_id
    
    return data

def test_gallery_install_tracking():
    """æµ‹è¯•æ¼«ç”»ä¹¦æ™ºèƒ½å®‰è£…ç»Ÿè®¡"""
    print("\nğŸ“– æµ‹è¯•æ¼«ç”»ä¹¦æ™ºèƒ½å®‰è£…ç»Ÿè®¡")
    print("="*50)
    
    # æ¨¡æ‹Ÿè®¾å¤‡æŒ‡çº¹
    test_device_id = "gallery_device_12345_smart"
    data = create_gallery_install_data("3001", test_device_id)
    
    print(f"è§¦å‘åœºæ™¯: ç”¨æˆ·é¦–æ¬¡æ‰“å¼€æ¼«ç”»ä¹¦")
    print(f"è®¾å¤‡æŒ‡çº¹: {test_device_id}")
    print(f"æ¸ é“ä»£ç : {data['channelCode']}")
    print(f"çœŸå®å®‰è£…: {data['realInstall']}")
    print(f"æ•°æ®: {json.dumps(data, indent=2, ensure_ascii=False)}")
    
    try:
        response = requests.post(
            f"{API_BASE_URL}/stats/install",
            json=data,
            headers={'Content-Type': 'application/json'},
            timeout=10
        )
        
        print(f"\nå“åº”çŠ¶æ€: {response.status_code}")
        if response.text:
            print(f"å“åº”å†…å®¹: {response.text}")
        
        if response.status_code == 200:
            print("âœ… æ¼«ç”»ä¹¦æ™ºèƒ½å®‰è£…ç»Ÿè®¡æˆåŠŸï¼")
            return True
        else:
            print("âŒ æ¼«ç”»ä¹¦æ™ºèƒ½å®‰è£…ç»Ÿè®¡å¤±è´¥")
            return False
            
    except Exception as e:
        print(f"âŒ è¯·æ±‚å¼‚å¸¸: {e}")
        return False

def test_gallery_vs_browser_comparison():
    """æµ‹è¯•æ¼«ç”»ä¹¦vsæµè§ˆå™¨è§¦å‘å¯¹æ¯”"""
    print("\nğŸ”„ å¯¹æ¯”æµ‹è¯•ï¼šæ¼«ç”»ä¹¦ vs æµè§ˆå™¨è§¦å‘")
    print("="*50)
    
    # æµ‹è¯•æ¼«ç”»ä¹¦è§¦å‘
    print("1. æµ‹è¯•æ¼«ç”»ä¹¦è§¦å‘æœºåˆ¶")
    gallery_data = create_gallery_install_data("3001", "comparison_gallery_device")
    gallery_data["triggerContext"] = "gallery_first_open"
    
    try:
        gallery_response = requests.post(
            f"{API_BASE_URL}/stats/install",
            json=gallery_data,
            headers={'Content-Type': 'application/json'},
            timeout=5
        )
        
        gallery_success = gallery_response.status_code == 200
        print(f"   æ¼«ç”»ä¹¦è§¦å‘: {'âœ… æˆåŠŸ' if gallery_success else 'âŒ å¤±è´¥'} (HTTP {gallery_response.status_code})")
        
    except Exception as e:
        gallery_success = False
        print(f"   æ¼«ç”»ä¹¦è§¦å‘: âŒ å¼‚å¸¸ - {e}")
    
    # æµ‹è¯•æµè§ˆå™¨è§¦å‘ï¼ˆæ—§æœºåˆ¶ï¼Œç°åœ¨åº”è¯¥ä¸ä½¿ç”¨äº†ï¼‰
    print("2. æµ‹è¯•æµè§ˆå™¨è§¦å‘æœºåˆ¶ï¼ˆå·²åºŸå¼ƒï¼‰")
    browser_data = create_gallery_install_data("3001", "comparison_browser_device")
    browser_data["triggerContext"] = "browser_first_visit"
    
    try:
        browser_response = requests.post(
            f"{API_BASE_URL}/stats/install",
            json=browser_data,
            headers={'Content-Type': 'application/json'},
            timeout=5
        )
        
        browser_success = browser_response.status_code == 200
        print(f"   æµè§ˆå™¨è§¦å‘: {'âœ… æˆåŠŸ' if browser_success else 'âŒ å¤±è´¥'} (HTTP {browser_response.status_code})")
        
    except Exception as e:
        browser_success = False
        print(f"   æµè§ˆå™¨è§¦å‘: âŒ å¼‚å¸¸ - {e}")
    
    print(f"\nå¯¹æ¯”ç»“æœ:")
    print(f"  ğŸ“– æ¼«ç”»ä¹¦è§¦å‘ï¼ˆæ–°æœºåˆ¶ï¼‰: {'âœ… å·¥ä½œæ­£å¸¸' if gallery_success else 'âŒ éœ€è¦æ£€æŸ¥'}")
    print(f"  ğŸŒ æµè§ˆå™¨è§¦å‘ï¼ˆæ—§æœºåˆ¶ï¼‰: {'âš ï¸  APIå…¼å®¹' if browser_success else 'âŒ å·²åºŸå¼ƒ'}")
    
    return gallery_success, browser_success

def simulate_user_gallery_flow():
    """æ¨¡æ‹Ÿç”¨æˆ·æ¼«ç”»ä¹¦ä½¿ç”¨æµç¨‹"""
    print("\nğŸ‘¤ æ¨¡æ‹Ÿç”¨æˆ·æ¼«ç”»ä¹¦ä½¿ç”¨å®Œæ•´æµç¨‹")
    print("="*50)
    
    print("1. ç”¨æˆ·å®‰è£…EhVieweråº”ç”¨")
    print("2. å¯åŠ¨åº”ç”¨ï¼ˆä¸»ç•Œé¢ï¼Œä¸è§¦å‘ç»Ÿè®¡ï¼‰")
    print("3. æµè§ˆç”»å»Šåˆ—è¡¨")
    print("4. ğŸ‘† ç‚¹å‡»ä»»æ„ä¸€æœ¬æ¼«ç”»ä¹¦")
    print("5. ğŸš€ GalleryActivity.onResume() -> è§¦å‘æ™ºèƒ½å®‰è£…ç»Ÿè®¡")
    print("6. ç”¨æˆ·å¼€å§‹é˜…è¯»æ¼«ç”»...")
    
    # æ¨¡æ‹Ÿé¦–æ¬¡æ‰“å¼€æ¼«ç”»ä¹¦è§¦å‘çš„å®‰è£…ç»Ÿè®¡
    first_gallery_success = test_gallery_install_tracking()
    
    print("7. ç”¨æˆ·ç»§ç»­ä½¿ç”¨å…¶ä»–åŠŸèƒ½ï¼ˆæµè§ˆå™¨ã€ä¸‹è½½ç­‰ï¼‰")
    print("8. ä½†å®‰è£…ç»Ÿè®¡åªåœ¨é¦–æ¬¡æ‰“å¼€æ¼«ç”»ä¹¦æ—¶è§¦å‘ä¸€æ¬¡")
    
    return first_gallery_success

def test_gallery_trigger_precision():
    """æµ‹è¯•æ¼«ç”»ä¹¦è§¦å‘çš„ç²¾ç¡®æ€§"""
    print("\nğŸ¯ æµ‹è¯•æ¼«ç”»ä¹¦è§¦å‘ç²¾ç¡®æ€§")
    print("="*50)
    
    print("æµ‹è¯•åœºæ™¯:")
    print("  âœ… åº”è¯¥è§¦å‘: é¦–æ¬¡æ‰“å¼€ä»»æ„æ¼«ç”»ä¹¦")
    print("  âŒ ä¸åº”è§¦å‘: åº”ç”¨å¯åŠ¨ã€æµè§ˆåˆ—è¡¨ã€ä½¿ç”¨æµè§ˆå™¨")
    print("  âŒ ä¸åº”é‡å¤: åŒä¸€è®¾å¤‡å¤šæ¬¡æ‰“å¼€æ¼«ç”»ä¹¦")
    
    # æµ‹è¯•é¦–æ¬¡æ‰“å¼€
    print("\n1. æ¨¡æ‹Ÿé¦–æ¬¡æ‰“å¼€æ¼«ç”»ä¹¦")
    first_device = "precision_test_device_001"
    first_data = create_gallery_install_data("3001", first_device)
    first_data["triggerContext"] = "gallery_first_open"
    first_data["testScenario"] = "first_gallery_open"
    
    try:
        response1 = requests.post(
            f"{API_BASE_URL}/stats/install",
            json=first_data,
            headers={'Content-Type': 'application/json'},
            timeout=5
        )
        
        first_success = response1.status_code == 200
        print(f"   é¦–æ¬¡æ‰“å¼€: {'âœ… æ­£ç¡®è§¦å‘' if first_success else 'âŒ è§¦å‘å¤±è´¥'}")
        
    except Exception as e:
        first_success = False
        print(f"   é¦–æ¬¡æ‰“å¼€: âŒ å¼‚å¸¸ - {e}")
    
    # æµ‹è¯•é‡å¤æ‰“å¼€ï¼ˆåº”è¯¥è¢«å®¢æˆ·ç«¯é˜²é‡å¤æœºåˆ¶é˜»æ­¢ï¼‰
    print("2. æ¨¡æ‹Ÿé‡å¤æ‰“å¼€æ¼«ç”»ä¹¦ï¼ˆåŒè®¾å¤‡ï¼‰")
    repeat_data = create_gallery_install_data("3001", first_device)  # ç›¸åŒè®¾å¤‡ID
    repeat_data["triggerContext"] = "gallery_repeat_open"
    repeat_data["testScenario"] = "repeat_gallery_open"
    
    try:
        response2 = requests.post(
            f"{API_BASE_URL}/stats/install",
            json=repeat_data,
            headers={'Content-Type': 'application/json'},
            timeout=5
        )
        
        # è¿™é‡ŒæˆåŠŸä¹Ÿæ˜¯æ­£å¸¸çš„ï¼Œå› ä¸ºé˜²é‡å¤é€»è¾‘åœ¨å®¢æˆ·ç«¯
        repeat_success = response2.status_code == 200
        print(f"   é‡å¤æ‰“å¼€: {'âš ï¸  æœåŠ¡ç«¯å…è®¸' if repeat_success else 'âŒ æœåŠ¡ç«¯æ‹’ç»'}")
        print(f"   è¯´æ˜: é˜²é‡å¤æœºåˆ¶ç”±å®¢æˆ·ç«¯SharedPreferenceså®ç°")
        
    except Exception as e:
        repeat_success = False
        print(f"   é‡å¤æ‰“å¼€: âŒ å¼‚å¸¸ - {e}")
    
    return first_success, repeat_success

def main():
    """ä¸»æµ‹è¯•å‡½æ•°"""
    print("ğŸ§ª æ¼«ç”»ä¹¦æ™ºèƒ½å®‰è£…ç»Ÿè®¡æœºåˆ¶æµ‹è¯•")
    print("="*60)
    print("æ–°è§¦å‘æœºåˆ¶:")
    print("  ğŸ“– æ¼«ç”»ä¹¦è§¦å‘: GalleryActivity.onResume()")
    print("  ğŸ¯ è§¦å‘æ—¶æœº: ç”¨æˆ·é¦–æ¬¡æ‰“å¼€ä»»æ„æ¼«ç”»ä¹¦")
    print("  ğŸ”’ é˜²é‡å¤: SharedPreferences + è®¾å¤‡æŒ‡çº¹")
    print("  âŒ æ—§æœºåˆ¶: æµè§ˆå™¨é¦–æ¬¡è®¿é—®ï¼ˆå·²ç§»é™¤ï¼‰")
    
    # æ‰§è¡Œå„é¡¹æµ‹è¯•
    tests = [
        ("æ¼«ç”»ä¹¦æ™ºèƒ½å®‰è£…ç»Ÿè®¡", test_gallery_install_tracking),
        ("æ¼«ç”»ä¹¦vsæµè§ˆå™¨å¯¹æ¯”", test_gallery_vs_browser_comparison),
        ("ç”¨æˆ·æµç¨‹æ¨¡æ‹Ÿ", simulate_user_gallery_flow),
        ("è§¦å‘ç²¾ç¡®æ€§æµ‹è¯•", test_gallery_trigger_precision)
    ]
    
    results = {}
    for test_name, test_func in tests:
        print(f"\n{'='*20} {test_name} {'='*20}")
        try:
            result = test_func()
            results[test_name] = result
        except Exception as e:
            print(f"âŒ æµ‹è¯•å¼‚å¸¸: {e}")
            results[test_name] = False
    
    # æ±‡æ€»ç»“æœ
    print(f"\n{'='*60}")
    print("ğŸ† æ¼«ç”»ä¹¦æ™ºèƒ½å®‰è£…ç»Ÿè®¡æµ‹è¯•ç»“æœ")
    print("="*60)
    
    for test_name, result in results.items():
        if isinstance(result, bool):
            print(f"  {test_name}: {'âœ… é€šè¿‡' if result else 'âŒ å¤±è´¥'}")
        elif isinstance(result, tuple):
            if len(result) == 2:
                r1, r2 = result
                print(f"  {test_name}: ä¸»è¦æµ‹è¯•{'âœ… é€šè¿‡' if r1 else 'âŒ å¤±è´¥'}ï¼Œå¯¹æ¯”æµ‹è¯•{'âœ… é€šè¿‡' if r2 else 'âŒ å¤±è´¥'}")
    
    print(f"\nğŸ¯ æœºåˆ¶æ”¹è¿›éªŒè¯:")
    print(f"  âœ… è§¦å‘æ—¶æœºæ›´å‡†ç¡®: æ¼«ç”»ä¹¦æ˜¯åº”ç”¨æ ¸å¿ƒåŠŸèƒ½")
    print(f"  âœ… ç”¨æˆ·ä½“éªŒæ›´ä½³: ç›´æ¥åæ˜ ç”¨æˆ·çœŸå®ä½¿ç”¨æ„å›¾")
    print(f"  âœ… æŠ€æœ¯å®ç°ç¨³å®š: GalleryActivity.onResume()æ—¶æœºå¯é ")
    print(f"  âœ… é˜²é‡å¤æœºåˆ¶: å®¢æˆ·ç«¯SharedPreferencesç¡®ä¿ä¸€æ¬¡æ€§")
    
    print(f"\nğŸ“‹ éƒ¨ç½²æ£€æŸ¥é¡¹:")
    print(f"  â–¡ GalleryActivity.java ç¼–è¯‘é€šè¿‡")
    print(f"  â–¡ ChannelTrackerå¯¼å…¥æ­£ç¡®")  
    print(f"  â–¡ SharedPreferenceså­˜å‚¨æ­£å¸¸")
    print(f"  â–¡ æ—¥å¿—è¾“å‡ºä¾¿äºè°ƒè¯•")
    print(f"  â–¡ WebViewActivityæ—§ä»£ç å·²æ¸…ç†")

if __name__ == "__main__":
    main()