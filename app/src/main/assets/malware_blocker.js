// ==UserScript==
// @name         EhViewer æ¶æ„è½¯ä»¶æ·±åº¦æ‹¦æˆªå™¨
// @namespace    http://ehviewer.com/
// @version      1.5.0
// @description  ä¸“é—¨æ‹¦æˆª360å®‰å…¨å«å£«ç­‰æ¶æ„è½¯ä»¶æ¨å¹¿ï¼Œä¿æŠ¤ç”¨æˆ·å…å—åƒåœ¾è½¯ä»¶ä¾µæ‰°
// @author       EhViewer Team
// @match        *://*/*
// @exclude      *://*.google.com/*
// @exclude      *://*.baidu.com/*
// @exclude      *://*.zhihu.com/*
// @grant        GM_getValue
// @grant        GM_setValue
// @grant        GM_addStyle
// @grant        GM_log
// @grant        GM_xmlhttpRequest
// ==/UserScript==

(function() {
    'use strict';

    GM_log('EhViewer æ¶æ„è½¯ä»¶æ·±åº¦æ‹¦æˆªå™¨å·²å¯åŠ¨');

    // æ¶æ„è½¯ä»¶æ•°æ®åº“ - æŒç»­æ›´æ–°
    const malwareDatabase = {
        // 360ç³»åˆ— - æœ€æ¶å¿ƒçš„åƒåœ¾è½¯ä»¶
        '360': [
            '360å®‰å…¨å«å£«', '360å®‰å…¨æµè§ˆå™¨', '360æ€æ¯’', '360åŠ é€Ÿå™¨', '360å‹ç¼©',
            '360é©±åŠ¨', '360æ‰‹æœºå«å£«', '360æ¸…ç†å¤§å¸ˆ', '360è½¯ä»¶ç®¡å®¶',
            '360é‡‘å±±æ¯’éœ¸', '360ä¸Šç½‘å¯¼èˆª', '360å®‰å…¨ä¸‹è½½', '360æ‰‹æ¸¸',
            '360æ¸¸æˆå¤§å…', '360äº‘ç›˜', '360æµè§ˆå™¨', '360æœç´¢', '360ç½‘å€å¯¼èˆª'
        ],

        // é‡‘å±±ç³»åˆ—
        'kingsoft': [
            'é‡‘å±±æ¯’éœ¸', 'é‡‘å±±å«å£«', 'é‡‘å±±æ¸…ç†ä¸“å®¶', 'é‡‘å±±é©±åŠ¨ç²¾çµ',
            'é‡‘å±±ç³»ç»Ÿæ€¥æ•‘ç®±', 'é‡‘å±±ç”µæ± åŒ»ç”Ÿ', 'é‡‘å±±ç½‘ç›¾', 'é‡‘å±±å®‰å…¨è½¯ä»¶'
        ],

        // ç™¾åº¦ç³»åˆ—
        'baidu': [
            'ç™¾åº¦å«å£«', 'ç™¾åº¦æ€æ¯’', 'ç™¾åº¦æµè§ˆå™¨', 'ç™¾åº¦è¾“å…¥æ³•',
            'ç™¾åº¦ç½‘ç›˜', 'ç™¾åº¦éŸ³ä¹', 'ç™¾åº¦è§†é¢‘', 'ç™¾åº¦åœ°å›¾',
            'ç™¾åº¦æ‰‹æœºå«å£«', 'ç™¾åº¦æ‰‹æœºåŠ©æ‰‹', 'ç™¾åº¦æ‰‹æœºæµè§ˆå™¨'
        ],

        // è…¾è®¯ç³»åˆ—
        'tencent': [
            'è…¾è®¯ç”µè„‘ç®¡å®¶', 'è…¾è®¯è§†é¢‘', 'QQæµè§ˆå™¨', 'å¾®ä¿¡',
            'QQéŸ³ä¹', 'QQæ¸¸æˆ', 'QQç©ºé—´', 'è…¾è®¯æ¸¸æˆ'
        ],

        // æœç‹—ç³»åˆ—
        'sogou': [
            'æœç‹—è¾“å…¥æ³•', 'æœç‹—æµè§ˆå™¨', 'æœç‹—é«˜é€Ÿä¸‹è½½', 'æœç‹—æ‹¼éŸ³',
            'æœç‹—äº”ç¬”', 'æœç‹—è¯åº“', 'æœç‹—å£çº¸', 'æœç‹—æˆªå›¾'
        ],

        // çŒè±¹ç³»åˆ—
        'liebao': [
            'çŒè±¹æµè§ˆå™¨', 'çŒè±¹æ¸…ç†å¤§å¸ˆ', 'çŒè±¹å®‰å…¨æµè§ˆå™¨',
            'çŒè±¹WiFiå¤§å¸ˆ', 'çŒè±¹è¯­éŸ³åŠ©æ‰‹'
        ],

        // 2345ç³»åˆ—
        '2345': [
            '2345åŠ é€Ÿæµè§ˆå™¨', '2345ç‹ç‰ŒåŠ©æ‰‹', '2345å¥½å‹',
            '2345çœ‹å›¾ç‹', '2345æ’­æ”¾å™¨', '2345å®‰å…¨å«å£«'
        ],

        // å…¶ä»–æ¶å¿ƒè½¯ä»¶
        'other': [
            'è¿…é›·çœ‹çœ‹', 'è¿…é›·å½±éŸ³', 'è¿…é›·æ¸¸æˆ', 'è¿…é›·ç›´æ’­',
            'æš´é£å½±éŸ³', 'æš´é£äº‘', 'æš´é£æ¸¸æˆ',
            'å¿«å‹', 'å¥½å‹', '2345å¥½å‹', '360å‹ç¼©',
            'é©±åŠ¨ç²¾çµ', 'é©±åŠ¨äººç”Ÿ', 'é©±åŠ¨æ€»è£',
            'é²å¤§å¸ˆ', 'ç”µè„‘ç®¡å®¶', 'è½¯ä»¶ç®¡å®¶',
            'è¶…çº§å…”å­', 'ä¼˜åŒ–å¤§å¸ˆ', 'ç³»ç»Ÿä¼˜åŒ–',
            'å…è´¹æ€æ¯’', 'å…è´¹å®‰å…¨è½¯ä»¶', 'å®‰å…¨å«å£«'
        ],

        // æµæ°“æ¨å¹¿
        'promotion': [
            'å®‰å…¨ä¸‹è½½', 'é«˜é€Ÿä¸‹è½½', 'ä¸‹è½½å¤§å¸ˆ', 'ä¸‹è½½åŠ é€Ÿå™¨',
            'æ¸¸æˆåŠ é€Ÿå™¨', 'ç½‘æ¸¸åŠ é€Ÿå™¨', 'æ‰‹æ¸¸åŠ é€Ÿå™¨',
            'ç³»ç»Ÿä¼˜åŒ–', 'ç³»ç»Ÿæ¸…ç†', 'ç³»ç»ŸåŠ é€Ÿ',
            'å…è´¹æ€æ¯’', 'å…è´¹æ€æ¯’è½¯ä»¶', 'å…è´¹å®‰å…¨è½¯ä»¶',
            'å®‰å…¨ä¸Šç½‘', 'ä¸Šç½‘åŠ é€Ÿ', 'ç½‘ç»œä¼˜åŒ–'
        ]
    };

    // æ¶æ„åŸŸååˆ—è¡¨
    const malwareDomains = [
        '360.cn', '360.com', '360safe.com', '360.cn',
        'kingsoft.com', 'duba.net', 'kingsoft.com',
        'baidu.com', 'baidusec.com', 'baidu.cn',
        'qq.com', 'tencent.com', 'weixin.qq.com',
        'sogou.com', 'soso.com', 'sogoucdn.com',
        'liebao.cn', 'lb.cn', 'liebao.com',
        '2345.com', '2345.cn', 'mypc.cn',
        'xunlei.com', 'thunder.com', 'xunlei.cn',
        'baofeng.com', 'baofeng.cn', 'storm.com',
        'kuaizip.com', 'goodpress.com', '2345goodpress.com',
        'drivergenius.com', 'driver.com', 'qudong.com',
        'ludashi.com', 'pcbutler.com', 'pcbutler.cn'
    ];

    // é…ç½®é€‰é¡¹
    const config = {
        enabled: GM_getValue('malwareBlockerEnabled', true),
        strictMode: GM_getValue('malwareStrictMode', false),
        showWarnings: GM_getValue('malwareShowWarnings', true),
        autoReport: GM_getValue('malwareAutoReport', false),
        customRules: GM_getValue('malwareCustomRules', [])
    };

    // ç»Ÿè®¡æ•°æ®
    let stats = {
        blockedElements: 0,
        blockedLinks: 0,
        blockedPopups: 0,
        lastUpdate: Date.now()
    };

    // åˆ›å»ºæ‹¦æˆªæ§åˆ¶é¢æ¿
    function createMalwareBlockerPanel() {
        const panel = document.createElement('div');
        panel.id = 'ehviewer-malware-panel';
        panel.innerHTML = `
            <div style="position: fixed; bottom: 20px; right: 20px; z-index: 10000;
                        background: linear-gradient(135deg, #FF4757, #FF3838); color: white;
                        padding: 12px; border-radius: 8px; font-size: 11px; font-family: Arial;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3); min-width: 180px;">
                <div style="display: flex; align-items: center; margin-bottom: 8px;">
                    <span style="font-size: 16px; margin-right: 6px;">ğŸ›¡ï¸</span>
                    <strong>æ¶æ„è½¯ä»¶æ‹¦æˆªå™¨</strong>
                </div>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; margin-bottom: 8px;">
                    <button id="scan-malware" title="æ‰«ææ¶æ„è½¯ä»¶">ğŸ”</button>
                    <button id="block-all" title="æ‹¦æˆªæ‰€æœ‰">ğŸš«</button>
                    <button id="clean-page" title="æ¸…ç†é¡µé¢">ğŸ§¹</button>
                    <button id="strict-mode" title="ä¸¥æ ¼æ¨¡å¼">âš ï¸</button>
                    <button id="report-mode" title="æŠ¥å‘Šæ¨¡å¼">ğŸ“Š</button>
                    <button id="settings-btn" title="è®¾ç½®">âš™ï¸</button>
                </div>
                <div style="font-size: 9px; color: rgba(255,255,255,0.8); text-align: center;
                           border-top: 1px solid rgba(255,255,255,0.2); padding-top: 4px;">
                    å·²æ‹¦æˆª: ${stats.blockedElements + stats.blockedLinks} ä¸ª
                </div>
            </div>
        `;
        document.body.appendChild(panel);

        // ç»‘å®šäº‹ä»¶
        document.getElementById('scan-malware').onclick = () => scanForMalware();
        document.getElementById('block-all').onclick = () => blockAllMalware();
        document.getElementById('clean-page').onclick = () => cleanPage();
        document.getElementById('strict-mode').onclick = () => toggleStrictMode();
        document.getElementById('report-mode').onclick = () => showReport();
        document.getElementById('settings-btn').onclick = showMalwareSettings;
    }

    // æ·±åº¦æ‰«ææ¶æ„è½¯ä»¶
    function scanForMalware() {
        GM_log('å¼€å§‹æ·±åº¦æ‰«ææ¶æ„è½¯ä»¶...');

        const scanResults = {
            found: [],
            blocked: 0,
            suspicious: 0
        };

        // æ‰«æé¡µé¢æ–‡æœ¬å†…å®¹
        scanPageContent(scanResults);

        // æ‰«æé“¾æ¥
        scanLinks(scanResults);

        // æ‰«æå›¾ç‰‡å’Œèµ„æº
        scanResources(scanResults);

        // æ˜¾ç¤ºæ‰«æç»“æœ
        showScanResults(scanResults);

        GM_log(`æ‰«æå®Œæˆï¼Œå‘ç° ${scanResults.found.length} ä¸ªæ¶æ„è½¯ä»¶å…ƒç´ `);
    }

    function scanPageContent(results) {
        const allText = document.body.textContent;
        const allElements = document.querySelectorAll('*');

        allElements.forEach(element => {
            const text = element.textContent || '';
            if (text.length > 0) {
                const foundMalware = checkForMalware(text);
                if (foundMalware.length > 0) {
                    results.found.push({
                        element: element,
                        type: 'text',
                        malware: foundMalware,
                        text: text.substring(0, 100)
                    });

                    // åœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹ç«‹å³éšè—
                    if (config.strictMode) {
                        element.style.display = 'none';
                        results.blocked++;
                        stats.blockedElements++;
                    }
                }
            }
        });
    }

    function scanLinks(results) {
        const links = document.querySelectorAll('a[href]');
        links.forEach(link => {
            const href = link.href.toLowerCase();
            const text = link.textContent.toLowerCase();

            // æ£€æŸ¥é“¾æ¥æ–‡æœ¬
            const textMalware = checkForMalware(text);
            if (textMalware.length > 0) {
                results.found.push({
                    element: link,
                    type: 'link-text',
                    malware: textMalware,
                    url: href
                });
            }

            // æ£€æŸ¥é“¾æ¥URL
            const isMalwareDomain = malwareDomains.some(domain =>
                href.includes(domain)
            );

            if (isMalwareDomain) {
                results.found.push({
                    element: link,
                    type: 'link-url',
                    malware: ['æ¶æ„åŸŸå'],
                    url: href
                });

                // æ‹¦æˆªæ¶æ„é“¾æ¥
                link.style.textDecoration = 'line-through';
                link.style.color = '#dc3545';
                link.title = 'âš ï¸ æ­¤é“¾æ¥å·²è¢«æ‹¦æˆªï¼ˆæ¶æ„è½¯ä»¶ï¼‰';

                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    showMalwareWarning(href);
                });

                results.blocked++;
                stats.blockedLinks++;
            }
        });
    }

    function scanResources(results) {
        // æ‰«æå›¾ç‰‡èµ„æº
        const images = document.querySelectorAll('img[src]');
        images.forEach(img => {
            const src = img.src.toLowerCase();
            const isMalwareImage = malwareDomains.some(domain =>
                src.includes(domain)
            );

            if (isMalwareImage) {
                results.found.push({
                    element: img,
                    type: 'image',
                    malware: ['æ¶æ„å›¾ç‰‡èµ„æº'],
                    url: src
                });

                if (config.strictMode) {
                    img.style.display = 'none';
                    results.blocked++;
                }
            }
        });

        // æ‰«æè„šæœ¬èµ„æº
        const scripts = document.querySelectorAll('script[src]');
        scripts.forEach(script => {
            const src = script.src.toLowerCase();
            const isMalwareScript = malwareDomains.some(domain =>
                src.includes(domain)
            );

            if (isMalwareScript) {
                results.found.push({
                    element: script,
                    type: 'script',
                    malware: ['æ¶æ„è„šæœ¬'],
                    url: src
                });

                script.remove();
                results.blocked++;
                GM_log('ç§»é™¤æ¶æ„è„šæœ¬: ' + src);
            }
        });
    }

    function checkForMalware(text) {
        const found = [];
        const lowerText = text.toLowerCase();

        Object.values(malwareDatabase).forEach(category => {
            category.forEach(malware => {
                if (lowerText.includes(malware.toLowerCase())) {
                    found.push(malware);
                }
            });
        });

        // æ£€æŸ¥è‡ªå®šä¹‰è§„åˆ™
        config.customRules.forEach(rule => {
            if (lowerText.includes(rule.toLowerCase())) {
                found.push('è‡ªå®šä¹‰è§„åˆ™: ' + rule);
            }
        });

        return [...new Set(found)]; // å»é‡
    }

    function showScanResults(results) {
        const resultDiv = document.createElement('div');
        resultDiv.innerHTML = `
            <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                        background: white; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                        z-index: 10001; max-width: 500px; max-height: 70vh; overflow-y: auto;">
                <div style="padding: 20px; border-bottom: 1px solid #eee;">
                    <h3 style="margin: 0 0 10px 0; color: #333;">ğŸ›¡ï¸ æ¶æ„è½¯ä»¶æ‰«æç»“æœ</h3>
                    <div style="display: flex; gap: 15px; font-size: 14px;">
                        <span style="color: #dc3545;">å‘ç°: ${results.found.length}</span>
                        <span style="color: #ffc107;">æ‹¦æˆª: ${results.blocked}</span>
                        <span style="color: #28a745;">å¯ç–‘: ${results.suspicious}</span>
                    </div>
                </div>
                <div style="padding: 20px;">
                    ${results.found.length > 0 ?
                        results.found.slice(0, 10).map(item => `
                            <div style="margin-bottom: 12px; padding: 10px; background: #f8f9fa;
                                       border-radius: 6px; border-left: 3px solid #dc3545;">
                                <div style="font-weight: bold; color: #dc3545; margin-bottom: 4px;">
                                    ${item.malware.join(', ')}
                                </div>
                                <div style="font-size: 12px; color: #666;">
                                    ç±»å‹: ${item.type} | å†…å®¹: ${item.text || item.url}
                                </div>
                            </div>
                        `).join('') :
                        '<div style="text-align: center; color: #28a745; padding: 20px;">ğŸ‰ æœªå‘ç°æ¶æ„è½¯ä»¶ï¼</div>'
                    }
                    ${results.found.length > 10 ?
                        `<div style="text-align: center; color: #666; margin-top: 10px;">
                            ... è¿˜æœ‰ ${results.found.length - 10} ä¸ªç»“æœ
                        </div>` : ''
                    }
                </div>
                <div style="padding: 15px; border-top: 1px solid #eee; text-align: right;">
                    <button onclick="this.parentElement.parentElement.remove()"
                            style="padding: 8px 16px; background: #6c757d; color: white;
                                   border: none; border-radius: 5px; cursor: pointer;">
                        å…³é—­
                    </button>
                </div>
            </div>
        `;

        document.body.appendChild(resultDiv);
    }

    // æ‹¦æˆªæ‰€æœ‰æ¶æ„è½¯ä»¶
    function blockAllMalware() {
        const allElements = document.querySelectorAll('*');
        let blockedCount = 0;

        allElements.forEach(element => {
            const text = element.textContent || '';
            const foundMalware = checkForMalware(text);

            if (foundMalware.length > 0) {
                element.style.display = 'none';
                blockedCount++;
                stats.blockedElements++;
            }
        });

        // æ‹¦æˆªæ‰€æœ‰å¯ç–‘é“¾æ¥
        const links = document.querySelectorAll('a[href]');
        links.forEach(link => {
            const href = link.href.toLowerCase();
            const isMalwareDomain = malwareDomains.some(domain =>
                href.includes(domain)
            );

            if (isMalwareDomain) {
                link.style.display = 'none';
                blockedCount++;
                stats.blockedLinks++;
            }
        });

        showNotification(`å·²æ‹¦æˆª ${blockedCount} ä¸ªæ¶æ„è½¯ä»¶å…ƒç´ `, 'success');
        GM_log(`æ‰¹é‡æ‹¦æˆªå®Œæˆï¼Œå…±å¤„ç† ${blockedCount} ä¸ªå…ƒç´ `);
    }

    // æ¸…ç†é¡µé¢
    function cleanPage() {
        // ç§»é™¤æ‰€æœ‰æ¶æ„å…ƒç´ 
        blockAllMalware();

        // æ¸…ç†å¼¹çª—
        const popups = document.querySelectorAll('.popup, .modal, .overlay, .dialog');
        popups.forEach(popup => {
            if (popup.offsetParent) {
                popup.remove();
                stats.blockedPopups++;
            }
        });

        // æ¸…ç†å¹¿å‘Š
        const ads = document.querySelectorAll('[class*="ad"], [id*="ad"], .advertisement');
        ads.forEach(ad => ad.remove());

        showNotification('é¡µé¢æ¸…ç†å®Œæˆï¼', 'success');
    }

    // ä¸¥æ ¼æ¨¡å¼åˆ‡æ¢
    function toggleStrictMode() {
        config.strictMode = !config.strictMode;
        GM_setValue('malwareStrictMode', config.strictMode);

        const button = document.getElementById('strict-mode');
        if (button) {
            button.textContent = config.strictMode ? 'ğŸ”’' : 'âš ï¸';
            button.title = config.strictMode ? 'ä¸¥æ ¼æ¨¡å¼å·²å¯ç”¨' : 'æ™®é€šæ¨¡å¼';
        }

        showNotification(
            config.strictMode ? 'ä¸¥æ ¼æ¨¡å¼å·²å¯ç”¨ï¼Œå°†è‡ªåŠ¨éšè—æ‰€æœ‰å¯ç–‘å†…å®¹' : 'æ™®é€šæ¨¡å¼å·²å¯ç”¨ï¼Œåªæ ‡è®°å¯ç–‘å†…å®¹',
            'info'
        );
    }

    // æ˜¾ç¤ºæŠ¥å‘Š
    function showReport() {
        const reportDiv = document.createElement('div');
        reportDiv.innerHTML = `
            <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                        background: white; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                        z-index: 10001; max-width: 400px;">
                <div style="padding: 20px; border-bottom: 1px solid #eee;">
                    <h3 style="margin: 0 0 15px 0; color: #333;">ğŸ“Š æ‹¦æˆªæŠ¥å‘Š</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: center;">
                        <div>
                            <div style="font-size: 24px; color: #dc3545;">${stats.blockedElements}</div>
                            <div style="font-size: 12px; color: #666;">æ‹¦æˆªå…ƒç´ </div>
                        </div>
                        <div>
                            <div style="font-size: 24px; color: #ffc107;">${stats.blockedLinks}</div>
                            <div style="font-size: 12px; color: #666;">æ‹¦æˆªé“¾æ¥</div>
                        </div>
                        <div>
                            <div style="font-size: 24px; color: #28a745;">${stats.blockedPopups}</div>
                            <div style="font-size: 12px; color: #666;">æ‹¦æˆªå¼¹çª—</div>
                        </div>
                        <div>
                            <div style="font-size: 24px; color: #17a2b8;">${Date.now() - stats.lastUpdate > 86400000 ? Math.floor((Date.now() - stats.lastUpdate) / 86400000) : 0}</div>
                            <div style="font-size: 12px; color: #666;">è¿è¡Œå¤©æ•°</div>
                        </div>
                    </div>
                </div>
                <div style="padding: 15px; text-align: right;">
                    <button onclick="this.parentElement.parentElement.remove()"
                            style="padding: 8px 16px; background: #6c757d; color: white;
                                   border: none; border-radius: 5px; cursor: pointer;">
                        å…³é—­
                    </button>
                </div>
            </div>
        `;

        document.body.appendChild(reportDiv);
    }

    // è®¾ç½®é¢æ¿
    function showMalwareSettings() {
        const settings = document.createElement('div');
        settings.innerHTML = `
            <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                        background: white; padding: 25px; border-radius: 12px; z-index: 10001;
                        box-shadow: 0 6px 24px rgba(0,0,0,0.3); max-width: 500px;">
                <h3 style="margin: 0 0 20px 0; color: #333; text-align: center;">æ¶æ„è½¯ä»¶æ‹¦æˆªå™¨è®¾ç½®</h3>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <label style="display: flex; align-items: center;">
                        <input type="checkbox" id="setting-enabled" style="margin-right: 8px;" ${config.enabled ? 'checked' : ''}>
                        å¯ç”¨æ‹¦æˆªå™¨
                    </label>
                    <label style="display: flex; align-items: center;">
                        <input type="checkbox" id="setting-strict" style="margin-right: 8px;" ${config.strictMode ? 'checked' : ''}>
                        ä¸¥æ ¼æ¨¡å¼
                    </label>
                    <label style="display: flex; align-items: center;">
                        <input type="checkbox" id="setting-warnings" style="margin-right: 8px;" ${config.showWarnings ? 'checked' : ''}>
                        æ˜¾ç¤ºè­¦å‘Š
                    </label>
                    <label style="display: flex; align-items: center;">
                        <input type="checkbox" id="setting-report" style="margin-right: 8px;" ${config.autoReport ? 'checked' : ''}>
                        è‡ªåŠ¨æŠ¥å‘Š
                    </label>
                </div>

                <div style="border-top: 1px solid #dee2e6; padding-top: 15px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; color: #666;">è‡ªå®šä¹‰æ‹¦æˆªè§„åˆ™</h4>
                    <textarea id="custom-rules" placeholder="æ¯è¡Œä¸€ä¸ªå…³é”®è¯" rows="4"
                              style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;">${config.customRules.join('\n')}</textarea>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">
                        æ·»åŠ è‡ªå®šä¹‰çš„æ¶æ„è½¯ä»¶å…³é”®è¯ï¼Œæ¯è¡Œä¸€ä¸ª
                    </div>
                </div>

                <div style="text-align: right;">
                    <button id="reset-malware-settings" style="margin-right: 10px; padding: 8px 15px;
                                                    background: #ffc107; color: black; border: none;
                                                    border-radius: 5px; cursor: pointer;">
                        é‡ç½®è®¾ç½®
                    </button>
                    <button id="save-malware-settings" style="padding: 8px 15px;
                                                    background: #FF4757; color: white; border: none;
                                                    border-radius: 5px; cursor: pointer;">
                        ä¿å­˜è®¾ç½®
                    </button>
                    <button id="close-malware-settings" style="margin-left: 10px; padding: 8px 15px;
                                                     background: #6c757d; color: white; border: none;
                                                     border-radius: 5px; cursor: pointer;">
                        å…³é—­
                    </button>
                </div>
            </div>
        `;

        document.body.appendChild(settings);

        document.getElementById('save-malware-settings').onclick = saveMalwareSettings;
        document.getElementById('reset-malware-settings').onclick = resetMalwareSettings;
        document.getElementById('close-malware-settings').onclick = () => settings.remove();
    }

    function saveMalwareSettings() {
        config.enabled = document.getElementById('setting-enabled').checked;
        config.strictMode = document.getElementById('setting-strict').checked;
        config.showWarnings = document.getElementById('setting-warnings').checked;
        config.autoReport = document.getElementById('setting-report').checked;

        const customRulesText = document.getElementById('custom-rules').value;
        config.customRules = customRulesText.split('\n').filter(rule => rule.trim());

        // ä¿å­˜è®¾ç½®
        Object.keys(config).forEach(key => {
            GM_setValue('malware' + key.charAt(0).toUpperCase() + key.slice(1), config[key]);
        });

        location.reload();
    }

    function resetMalwareSettings() {
        if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰è®¾ç½®ä¸ºé»˜è®¤å€¼å—ï¼Ÿ')) {
            GM_setValue('malwareBlockerEnabled', true);
            GM_setValue('malwareStrictMode', false);
            GM_setValue('malwareShowWarnings', true);
            GM_setValue('malwareAutoReport', false);
            GM_setValue('malwareCustomRules', []);

            location.reload();
        }
    }

    // æ¶æ„è½¯ä»¶è­¦å‘Š
    function showMalwareWarning(url) {
        if (!config.showWarnings) return;

        const warning = document.createElement('div');
        warning.innerHTML = `
            <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                        background: white; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                        z-index: 10001; max-width: 400px; text-align: center;">
                <div style="padding: 30px 20px;">
                    <div style="font-size: 48px; margin-bottom: 15px;">âš ï¸</div>
                    <h3 style="margin: 0 0 15px 0; color: #dc3545;">æ£€æµ‹åˆ°æ¶æ„è½¯ä»¶é“¾æ¥</h3>
                    <p style="margin: 0 0 20px 0; color: #666; line-height: 1.5;">
                        è¯¥é“¾æ¥å¯èƒ½åŒ…å«æ¶æ„è½¯ä»¶æˆ–æ†ç»‘å®‰è£…ç¨‹åºï¼Œ<br>
                        å»ºè®®ä¸è¦ä¸‹è½½æˆ–è®¿é—®æ­¤é“¾æ¥ã€‚
                    </p>
                    <div style="font-size: 12px; color: #999; margin-bottom: 20px; word-break: break-all;">
                        ${url}
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()"
                            style="padding: 10px 25px; background: #6c757d; color: white;
                                   border: none; border-radius: 6px; cursor: pointer;">
                        æˆ‘çŸ¥é“äº†
                    </button>
                </div>
            </div>
        `;

        document.body.appendChild(warning);
    }

    // é€šçŸ¥ç³»ç»Ÿ
    function showNotification(message, type = 'info') {
        const colors = {
            success: '#28a745',
            error: '#dc3545',
            warning: '#ffc107',
            info: '#17a2b8'
        };

        const notification = document.createElement('div');
        notification.innerHTML = `
            <div style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
                        background: ${colors[type]}; color: white; padding: 12px 24px;
                        border-radius: 8px; z-index: 10001; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        font-size: 14px; font-weight: bold;">
                ${message}
            </div>
        `;
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 3000);
    }

    // é”®ç›˜å¿«æ·é”®
    function setupKeyboardShortcuts() {
        document.addEventListener('keydown', function(e) {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

            // Ctrl+Shift+M - æ‰«ææ¶æ„è½¯ä»¶
            if (e.ctrlKey && e.shiftKey && e.keyCode === 77) {
                e.preventDefault();
                scanForMalware();
            }

            // Ctrl+Shift+B - æ‹¦æˆªæ‰€æœ‰æ¶æ„è½¯ä»¶
            if (e.ctrlKey && e.shiftKey && e.keyCode === 66) {
                e.preventDefault();
                blockAllMalware();
            }

            // Ctrl+Shift+C - æ¸…ç†é¡µé¢
            if (e.ctrlKey && e.shiftKey && e.keyCode === 67) {
                e.preventDefault();
                cleanPage();
            }
        });
    }

    // è‡ªåŠ¨æ›´æ–°æ¶æ„è½¯ä»¶æ•°æ®åº“
    function updateMalwareDatabase() {
        // è¿™é‡Œå¯ä»¥æ·»åŠ è‡ªåŠ¨æ›´æ–°é€»è¾‘
        // ä»æœåŠ¡å™¨è·å–æœ€æ–°çš„æ¶æ„è½¯ä»¶æ•°æ®åº“
        GM_log('æ¶æ„è½¯ä»¶æ•°æ®åº“æ£€æŸ¥æ›´æ–°...');
    }

    // ä¿å­˜ç»Ÿè®¡æ•°æ®
    function saveStats() {
        GM_setValue('malwareStats', stats);
    }

    // åˆå§‹åŒ–
    function init() {
        if (!config.enabled) {
            GM_log('æ¶æ„è½¯ä»¶æ‹¦æˆªå™¨å·²ç¦ç”¨');
            return;
        }

        setTimeout(() => {
            createMalwareBlockerPanel();
            setupKeyboardShortcuts();

            // åŠ è½½å·²ä¿å­˜çš„ç»Ÿè®¡æ•°æ®
            const savedStats = GM_getValue('malwareStats', {});
            Object.assign(stats, savedStats);

            // è‡ªåŠ¨æ‰«æï¼ˆå»¶è¿Ÿæ‰§è¡Œï¼‰
            setTimeout(() => {
                if (config.strictMode) {
                    scanForMalware();
                }
            }, 3000);

            GM_log('EhViewer æ¶æ„è½¯ä»¶æ·±åº¦æ‹¦æˆªå™¨åˆå§‹åŒ–å®Œæˆ');
        }, 1000);

        // å®šæœŸä¿å­˜ç»Ÿè®¡
        setInterval(saveStats, 30000);
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }

})();
