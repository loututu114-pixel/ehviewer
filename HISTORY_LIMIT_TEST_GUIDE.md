# EhViewer 历史记录限制功能测试指南

## 🎯 测试目标

验证历史记录限制为30条的功能是否正常工作，包括自动清理过期记录。

## 📋 测试环境

### 设备要求
- Android 版本：8.0+
- EhViewer 版本：优化后的版本
- 存储空间：足够的数据库存储空间

### 测试工具
- Android Studio (数据库查看)
- 浏览器 (生成历史记录)
- Logcat (日志查看)

## 🧪 测试案例

### 1. 基础功能测试

#### 1.1 历史记录限制设置验证
**测试步骤：**
1. 查看HistoryManager常量设置
2. 确认MAX_HISTORY_COUNT值为30
3. 检查日志输出中的限制信息

**预期结果：**
- ✅ MAX_HISTORY_COUNT = 30
- ✅ 日志显示"History stats: X/30 records"

#### 1.2 历史记录统计功能
**测试步骤：**
1. 打开应用
2. 点击历史记录按钮
3. 查看对话框标题显示的统计信息

**预期结果：**
- ✅ 标题显示"历史记录 (X/30)"
- ✅ X不超过30

### 2. 自动清理测试

#### 2.1 模拟大量历史记录
**测试步骤：**
1. 创建一个测试脚本来生成31条不同的历史记录
2. 观察数据库变化
3. 检查是否自动清理到30条

**预期结果：**
- ✅ 数据库中最多保留30条记录
- ✅ 日志显示清理操作

#### 2.2 重复访问计数测试
**测试步骤：**
1. 多次访问同一个网站
2. 检查访问计数是否正确更新
3. 验证记录数量没有超过限制

**预期结果：**
- ✅ 重复访问不增加记录数量
- ✅ visitCount字段正确更新

### 3. 性能测试

#### 3.1 清理性能测试
**测试步骤：**
1. 生成大量历史记录（50+条）
2. 触发清理操作
3. 测量清理耗时

**预期结果：**
- ✅ 清理操作在1秒内完成
- ✅ 应用响应正常

#### 3.2 数据库查询性能
**测试步骤：**
1. 在有30条历史记录的情况下查询
2. 测试获取最近记录的性能
3. 验证统计功能响应时间

**预期结果：**
- ✅ 查询响应时间<100ms
- ✅ UI显示流畅

## 📊 测试数据准备

### 测试网站列表
准备31个不同的测试网站：
```
https://www.baidu.com
https://www.google.com
https://www.github.com
https://www.stackoverflow.com
https://www.bilibili.com
... (继续添加至31个)
```

### 自动化测试脚本
```java
// 批量生成历史记录的测试方法
private void generateTestHistory() {
    HistoryManager historyManager = HistoryManager.getInstance(context);
    for (int i = 1; i <= 35; i++) {
        String url = "https://test-site-" + i + ".com";
        String title = "测试网站 " + i;
        historyManager.addHistory(title, url);
    }
}
```

## 🔍 调试信息

### 日志过滤
使用以下命令查看历史记录相关日志：
```bash
adb logcat | grep -E "(HistoryManager|history)"
```

### 数据库检查
通过Android Studio的Database Inspector查看：
1. 历史记录表结构
2. 记录数量统计
3. 清理操作效果

### 预期日志输出
```
HistoryManager: Cleaned old history records: removed 5 records, kept 30 recent records
WebViewActivity: History stats: 30/30 records
```

## 📈 性能基准

### 存储限制
- **历史记录数量**：≤30条
- **数据库大小**：<1MB
- **单个记录大小**：<10KB

### 响应时间
- **添加记录**：<50ms
- **查询记录**：<100ms
- **清理操作**：<500ms

## 🛠️ 故障排除

### 问题1：记录数量超过30条
**现象：**数据库中记录数超过限制
**排查：**
1. 检查cleanOldHistory方法是否被调用
2. 验证SQL删除语句是否正确
3. 查看数据库事务是否提交

### 问题2：清理操作失败
**现象：**日志显示清理错误
**排查：**
1. 检查数据库写权限
2. 验证SQL语句语法
3. 查看异常堆栈信息

### 问题3：统计信息不准确
**现象：**UI显示的统计与实际不符
**排查：**
1. 检查getHistoryCount方法实现
2. 验证数据库查询结果
3. 查看缓存是否过期

## 📋 测试报告模板

```markdown
## 历史记录限制功能测试报告

**测试日期：** YYYY-MM-DD
**测试人员：** [姓名]
**EhViewer版本：** [版本号]

### 功能测试
- [x] 历史记录限制为30条
- [x] 自动清理过期记录
- [x] 统计信息准确显示

### 性能测试
- [x] 清理操作耗时<500ms
- [x] 查询响应<100ms
- [x] 数据库大小正常

### 问题发现
1. [问题描述及严重程度]
2. [问题描述及严重程度]

### 测试数据
| 项目 | 预期值 | 实际值 | 状态 |
|------|--------|--------|------|
| 最大记录数 | 30 | [实际值] | [✅/❌] |
| 清理耗时 | <500ms | [实际值]ms | [✅/❌] |
| 查询耗时 | <100ms | [实际值]ms | [✅/❌] |

### 结论
[测试是否通过，功能是否正常]
```

## 🎯 验收标准

### 功能验收
- [x] 历史记录数量限制为30条
- [x] 超过30条时自动清理
- [x] 保留最近访问的记录
- [x] UI正确显示统计信息

### 性能验收
- [x] 清理操作高效快速
- [x] 查询响应及时
- [x] 数据库存储合理

### 稳定性验收
- [x] 无内存泄漏
- [x] 无数据库异常
- [x] 日志记录完整

## 🚀 部署建议

### 数据库迁移
如果从旧版本升级，需要考虑数据库清理：
```sql
-- 清理超过30条的旧记录
DELETE FROM history WHERE id NOT IN (
    SELECT id FROM history ORDER BY visit_time DESC LIMIT 30
);
```

### 用户通知
在应用更新时提醒用户：
```
📢 历史记录优化
为了提升应用性能，历史记录现限制为30条。
旧记录将自动清理，只保留最近访问的记录。
```

---

**测试指南版本**：1.0
**最后更新**：2024年1月15日
**适用版本**：EhViewer v1.9.9.17+
**维护人员**：EhViewer开发团队
